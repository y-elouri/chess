import unittest

import chess

initial_moves = {
    ('\u265C', 21): set(),
    ('\u265E', 22): {41, 43},
    ('\u265D', 23): set(),
    ('\u265B', 24): set(),
    ('\u265A', 25): set(),
    ('\u265D', 26): set(),
    ('\u265E', 27): {46, 48},
    ('\u265C', 28): set(),
    ('\u265F', 31): {41, 51},
    ('\u265F', 32): {42, 52},
    ('\u265F', 33): {43, 53},
    ('\u265F', 34): {44, 54},
    ('\u265F', 35): {45, 55},
    ('\u265F', 36): {46, 56},
    ('\u265F', 37): {47, 57},
    ('\u265F', 38): {48, 58},
    ('\u2659', 81): {71, 61},
    ('\u2659', 82): {72, 62},
    ('\u2659', 83): {73, 63},
    ('\u2659', 84): {74, 64},
    ('\u2659', 85): {75, 65},
    ('\u2659', 86): {76, 66},
    ('\u2659', 87): {77, 67},
    ('\u2659', 88): {78, 68},
    ('\u2656', 91): set(),
    ('\u2658', 92): {71, 73},
    ('\u2657', 93): set(),
    ('\u2655', 94): set(),
    ('\u2654', 95): set(),
    ('\u2657', 96): set(),
    ('\u2658', 97): {76, 78},
    ('\u2656', 98): set()
}
moves2 = {
    ('\u265C', 21): {22, 23, 24},
    ('\u265E', 42): {61, 63, 54, 23},
    ('\u265D', 41): {32, 23, 52, 63, 74, 85},
    ('\u265B', 35): {24, 26, 44, 53},
    ('\u265A', 25): {24, 23, 26, 27},
    ('\u265D', 37): {26, 48},
    ('\u265E', 46): {27, 38, 58, 67, 65, 54},
    ('\u265C', 28): {27, 26, 38, 48, 58, 68},
    ('\u265F', 31): set(),
    ('\u265F', 62): {72, 73},
    ('\u265F', 33): {43, 53},
    ('\u265F', 34): {44},
    ('\u265F', 45): {54},
    ('\u265F', 36): set(),
    ('\u265F', 47): {57},
    ('\u265F', 78): {87},
    ('\u2659', 81): {71, 61},
    ('\u2659', 82): {72},
    ('\u2659', 83): set(),
    ('\u2659', 54): {44, 45},
    ('\u2659', 65): set(),
    ('\u2659', 86): set(),
    ('\u2659', 87): {77, 78, 67},
    ('\u2659', 88): set(),
    ('\u2656', 91): {92, 93, 94},
    ('\u2658', 73): {92, 94, 61, 52},
    ('\u2657', 84): {93, 75, 66, 57, 48},
    ('\u2655', 76): {75, 74, 77, 78, 66, 56, 46, 67, 58},
    ('\u2654', 95): {94, 93, 96, 97},
    ('\u2657', 85): {94, 96, 74, 63, 52, 41},
    ('\u2658', 55): {74, 63, 43, 34, 36, 47, 67},
    ('\u2656', 98): {97, 96}
}
moves3 = {
    ('\u265F', 33): {43, 53},
    ('\u265F', 44): {54},
    ('\u265F', 66): set(),
    ('\u265C', 58): {48, 38, 28, 57, 56, 55, 54, 53, 52},
    ('\u265A', 68): {57, 67, 77},
    ('\u2659', 52): set(),
    ('\u2659', 85): {75, 65},
    ('\u2659', 87): {77, 67},
    ('\u2656', 62): {72, 82, 92, 61, 63, 64, 65, 66},
    ('\u2654', 51): {61, 41}
}
moves4 = {
    ('\u265C', 21): {22, 23, 24, 31},
    ('\u265E', 51): {63, 72, 43},
    ('\u265D', 47): {58, 56, 65},
    ('\u265B', 71): {61, 62, 81, 72, 73, 74, 75, 76},
    ('\u265A', 25): {24, 23},
    ('\u265D', 42): {31, 53, 64, 75, 86, 97},
    ('\u265E', 46): {65, 54, 27, 58, 67},
    ('\u265C', 28): {27, 26},
    ('\u265F', 82): {91, 92},
    ('\u265F', 32): set(),
    ('\u265F', 33): {43, 53},
    ('\u265F', 34): {44, 54},
    ('\u265F', 36): set(),
    ('\u265F', 37): {48},
    ('\u265F', 38): set(),
    ('\u2659', 31): set(),
    ('\u2659', 81): set(),
    ('\u2659', 52): set(),
    ('\u2659', 63): {53},
    ('\u2659', 65): set(),
    ('\u2659', 87): set(),
    ('\u2659', 88): set(),
    ('\u2659', 84): {64},
    ('\u2656', 91): set(),
    ('\u2658', 48): set(),
    ('\u2657', 62): {53},
    ('\u2655', 94): set(),
    ('\u2654', 97): {98},
    ('\u2657', 61): set(),
    ('\u2658', 76): {64},
    ('\u2656', 96): {86} 
}
moves5 = {
    ('\u265C', 21): set(),
    ('\u265E', 22): {41, 34},
    ('\u265D', 23): {34},
    ('\u265B', 24): {25, 34, 33, 42, 51},
    ('\u265A', 26): {27},
    ('\u265D', 35): {44, 53, 62, 71, 46, 57, 68},
    ('\u265E', 86): {94, 74, 65, 67, 78, 98},
    ('\u265C', 28): {27},
    ('\u265F', 31): {41, 51},
    ('\u265F', 32): {42, 52},
    ('\u265F', 43): {53},
    ('\u265F', 36): {46, 56},
    ('\u265F', 37): {47, 57},
    ('\u265F', 38): {48, 58},
    ('\u2659', 81): {71, 61},
    ('\u2659', 82): {72, 62},
    ('\u2659', 83): {73},
    ('\u2659', 34): {23},
    ('\u2659', 87): {77, 67},
    ('\u2659', 88): {78, 68},
    ('\u2656', 91): set(),
    ('\u2658', 92): {71, 73, 84},
    ('\u2657', 93): {84, 75, 66, 57, 48},
    ('\u2655', 94): {84, 74, 64, 54, 44},
    ('\u2654', 95): {84, 86, 96, 97},
    ('\u2657', 63): {72, 54, 45, 36, 74, 52, 41},
    ('\u2658', 85): {73, 64, 66, 77, 97},
    ('\u2656', 98): {97, 96}
}
moves6 = {
    ('\u265C', 21): {22, 23, 24, 25, 31},
    ('\u265E', 43): {22, 31, 51, 62, 64, 24},
    ('\u265D', 67): {78, 58, 76, 56, 45, 34, 23},
    ('\u265B', 35): {24, 25, 34, 45},
    ('\u265A', 27): {28},
    ('\u265D', 53): {31, 42, 64, 75, 86, 62, 71},
    ('\u265E', 46): {25, 34, 54, 65, 58},
    ('\u265C', 26): {25, 24, 23, 22},
    ('\u265F', 41): {51},
    ('\u265F', 32): {42, 52},
    ('\u265F', 33): set(),
    ('\u265F', 44): {54},
    ('\u265F', 55): set(),
    ('\u265F', 36): set(),
    ('\u265F', 37): {47},
    ('\u265F', 38): {48, 58},
    ('\u2659', 71): {61},
    ('\u2659', 82): {72, 62},
    ('\u2659', 83): set(),
    ('\u2659', 74): {64},
    ('\u2659', 65): set(),
    ('\u2659', 86): set(),
    ('\u2659', 87): {77},
    ('\u2659', 88): {78, 68},
    ('\u2656', 91): {92, 93, 94, 95, 81},
    ('\u2658', 73): {94, 92, 81, 61, 52, 54},
    ('\u2657', 57): {68, 46, 48, 66, 75, 84, 93},
    ('\u2655', 85): {95, 94, 84, 75},
    ('\u2654', 97): {98},
    ('\u2657', 63): {52, 41, 81, 72, 54, 45, 36},
    ('\u2658', 76): {95, 84, 64, 55, 68},
    ('\u2656', 96): {95, 94, 93, 92}
}

class TestChessBoard(unittest.TestCase):
    """Test cases from: https://www.chessprogramming.org/Perft_Results"""

    def test_move_generation(self):
        positions = [
            (self.__load_test_position('board.bin', 95, 25), initial_moves),
            (self.__load_test_position('position2.bin', 95, 25), moves2),
            (self.__load_test_position('position3.bin', 51, 68), moves3),
            (self.__load_test_position('position4.bin', 97, 25), moves4),
            (self.__load_test_position('position5.bin', 95, 26), moves5),
            (self.__load_test_position('position6.bin', 97, 27), moves6)
        ]
        for chess_board, correct_moves in positions:
            with self.subTest(chess_board=chess_board, correct_moves=correct_moves):
                actual_moves = {}
                for square in range(21, 100):
                    if 0 < chess_board.board[square] < 255:
                        moves = chess.legal_moves(chess_board, square, castle=True)
                        actual_moves[(chess._i2symbol(chess_board.board[square]), square)] = set(moves)
                self.assertEqual(actual_moves, correct_moves)

    @staticmethod
    def __load_test_position(filename, wk, bk):
        with open(filename, mode='rb') as f:
            return chess.ChessBoard(f.read(120), True, 0, 0, wk, bk)
